<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <link rel="alternate icon" type="image/png" href="/img/favicon.ico">
  <title>
    
      ARM 中常用的乘累加（MAC）指令总结 |
     
    Blog
  </title>
  
<link rel="stylesheet" href="/css/maoblog.css">

  
<link rel="stylesheet" href="/css/partials/post.css">

  
<link rel="stylesheet" href="/css/partials/comment.css">

  
<link rel="stylesheet" href="/css/partials/search.css">

  
<link rel="stylesheet" href="/css/partials/meta.css">

  
<link rel="stylesheet" href="/css/partials/about.css">

  
<link rel="stylesheet" href="/fontawesome/css/font-awesome.min.css">

  
<link rel="stylesheet" href="/css/zoom.css">

  
<link rel="stylesheet" href="/css/prism.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/math/katex.min.css">

<link rel="stylesheet" href="/css/math/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
</head>


  <body>
    <div class="body-container">
      <div class="body-main">
        <div class="header-wrapper"><div class="header">
  <a class="logo" href="/">Blog</a>
  <ul class="nav">
    
      
        <li><a href="/">Posts</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
      
        <li><a style="cursor: pointer;" onclick="openSearchBar()">Search</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
    <!-- <li class="site-mode">light</i></li> -->
  </ul>
</div>
<div class="search-bar-container">  
    <div class="search-bar">
        <input id="search-input" value="" class="search-input" autofocus placeholder="Search something..." type="text" onblur="hideSearchBar()" oninput="exportSearchContent()">
    </div>
    <div class="search-output">
        <ul class="search-output-list">
            <!-- 结果列表 -->
            <!-- <span style="padding-left: 3px; margin-left: 3px;">无记录</span> -->
            <li class="Searching">
                <div class="content">
                    Searching...
                </div>
            </li>
        </ul>
        <span style="padding-left: 3px; margin-left: 3px; font-size: 13px;"><em>Powered by <span  onclick="goToLink(this)"><a href="/search.xml" class="search-xml li-link">search.xml</a></span></em></span>
    </div>
</div></div>
        <div class="main-wrapper"><main>
  <div class="main-container">
      <div class="post-details">
          
            <div class="post-title">
              <h1>ARM 中常用的乘累加（MAC）指令总结</h1>
            </div>
          
          <div class="post-content">
            <hr />
<h1 id="arm-中常用的乘累加mac指令总结"><a class="markdownIt-Anchor" href="#arm-中常用的乘累加mac指令总结"></a> ARM 中常用的乘累加（MAC）指令总结</h1>
<p>在现代 CPU 和 AI 加速器的指令集中，<strong>乘-累加（Multiply-Accumulate, MAC）</strong> 是最核心的计算操作之一。<br />
无论是 <strong>卷积</strong>、<strong>矩阵乘法</strong> 还是 <strong>深度学习中的 GEMM</strong>，其本质都是大量的 MAC 运算。</p>
<p>在 ARM 架构下，针对不同的数据类型和应用场景，演进出了多种 <strong>乘累加指令</strong>。本文将对常见的几类进行梳理，并配合伪代码展示它们的计算方式。</p>
<hr />
<h2 id="1-fmla-基础乘累加"><a class="markdownIt-Anchor" href="#1-fmla-基础乘累加"></a> 1. FMLA —— 基础乘累加</h2>
<p><strong>FMLA (Floating-point Multiply-Accumulate)</strong> 是最基础的向量乘累加指令。</p>
<ul>
<li>
<p><strong>指令集</strong>：<code>&gt;= ARMv7 (float32)</code>，<code>&gt;= ARMv8 (float16)</code></p>
</li>
<li>
<p><strong>常见 NEON 接口</strong>：</p>
<ul>
<li><code>float32x4_t vfmaq_f32(float32x4_t a, float32x4_t b, float32x4_t c)</code></li>
<li><code>float16x8_t vfmaq_f16(float16x8_t a, float16x8_t b, float16x8_t c)</code></li>
</ul>
</li>
<li>
<p><strong>运算逻辑</strong>：逐元素乘加</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> src1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> src2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<blockquote>
<p>典型用途：浮点向量加速，如卷积核点积、向量化计算。</p>
</blockquote>
<hr />
<h2 id="2-dot-向量点积"><a class="markdownIt-Anchor" href="#2-dot-向量点积"></a> 2. DOT —— 向量点积</h2>
<p>为了更高效地处理 <strong>int8 量化推理</strong>，ARM 在 <strong>ARMv8.2</strong> 中引入了 <strong>DOT (Dot Product)</strong> 指令。</p>
<ul>
<li>
<p><strong>指令集</strong>：<code>&gt;= ARMv8.2</code></p>
</li>
<li>
<p><strong>常见 NEON 接口</strong>：</p>
<ul>
<li><code>int32x4_t vdotq_s32(int32x4_t r, int8x16_t a, int8x16_t b)</code></li>
<li><code>int32x4_t vusdotq_s32(int32x4_t r, uint8x16_t a, int8x16_t b)</code></li>
</ul>
</li>
<li>
<p><strong>运算逻辑</strong>：分块点积 (4 × 4 → int32)</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> src1<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">*</span> src2<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<blockquote>
<p>典型用途：卷积、点积，特别适合 int8 量化模型。</p>
</blockquote>
<hr />
<h2 id="3-mmla-矩阵乘累加"><a class="markdownIt-Anchor" href="#3-mmla-矩阵乘累加"></a> 3. MMLA —— 矩阵乘累加</h2>
<p>在 <strong>ARMv8.6</strong> 之后，进一步推出了 <strong>MMLA (Matrix Multiply-Accumulate)</strong> 指令，可以直接把 <strong>小块向量视为矩阵</strong>，一次性完成 <strong>2×8 × 8×2</strong> 的矩阵乘法。</p>
<ul>
<li>
<p><strong>指令集</strong>：<code>&gt;= ARMv8.6</code></p>
</li>
<li>
<p><strong>常见 NEON 接口</strong>：</p>
<ul>
<li><code>int32x4_t vmmlaq_s32(int32x4_t r, int8x16_t a, int8x16_t b)</code></li>
<li><code>int32x4_t vusmmlaq_s32(int32x4_t r, uint8x16_t a, int8x16_t b)</code></li>
</ul>
</li>
<li>
<p><strong>运算逻辑</strong>：小矩阵乘法</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            dst<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">+=</span> src1<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> src2<span class="token punctuation">[</span>j <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<blockquote>
<p>典型用途：高效的 int8 GEMM，加速深度学习推理。</p>
</blockquote>
<hr />
<h2 id="4-bfmmla-bfloat16-矩阵乘累加"><a class="markdownIt-Anchor" href="#4-bfmmla-bfloat16-矩阵乘累加"></a> 4. BFMMLA —— BFloat16 矩阵乘累加</h2>
<p>为了更好地支持 <strong>AI 训练与推理</strong>，ARMv8.6 又引入了 <strong>BFMMLA (BFloat16 Matrix Multiply-Accumulate)</strong>，专门处理 <strong>bfloat16 × bfloat16 → float32</strong>。</p>
<ul>
<li>
<p><strong>指令集</strong>：<code>&gt;= ARMv8.6</code></p>
</li>
<li>
<p><strong>常见 NEON 接口</strong>：</p>
<ul>
<li><code>float32x4_t vbfmmlaq_f32(float32x4_t r, bfloat16x8_t a, bfloat16x8_t b)</code></li>
</ul>
</li>
<li>
<p><strong>运算逻辑</strong>：小矩阵乘法</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            dst<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">+=</span> src1<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> src2<span class="token punctuation">[</span>j <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<blockquote>
<p>典型用途：深度学习训练（bfloat16 是目前主流 AI 训练精度格式）。</p>
</blockquote>
<table>
<thead>
<tr>
<th>指令</th>
<th>指令集</th>
<th>数据类型</th>
<th>运算规模</th>
<th>主要用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>FMLA</strong></td>
<td>ARMv7/ARMv8</td>
<td>FP16/FP32</td>
<td>逐元素</td>
<td>浮点向量运算</td>
</tr>
<tr>
<td><strong>SDOT/USDOT</strong></td>
<td>ARMv8.2</td>
<td>int8/uint8 → int32</td>
<td>4×4 点积</td>
<td>int8 卷积、点积</td>
</tr>
<tr>
<td><strong>SMMLA/USMMLA</strong></td>
<td>ARMv8.6</td>
<td>int8/uint8 → int32</td>
<td>2×2×8 矩阵</td>
<td>int8 GEMM</td>
</tr>
<tr>
<td><strong>BFMMLA</strong></td>
<td>ARMv8.6</td>
<td>bfloat16 → float32</td>
<td>2×2×4 矩阵</td>
<td>深度学习 (bfloat16)</td>
</tr>
</tbody>
</table>
<hr />

          </div>
          
            <div class="dot-line"></div>
            <div class="post-meta">
              <div class="post-date">
                <i class="fa fa-calendar"></i>&nbsp;&nbsp;<span class="post-date">2024/12/01</span>
              </div>
              <div class="post-tags">
                 
                  
                    <div class="tag-item">
                      <a href="/tags/ARM/"><i class="fa fa-tag"></i>&nbsp;&nbsp;ARM</a>
                    </div>
                  
                
              </div>
            </div>
          
      </div>
  </div>
</main>

<script src="https://giscus.app/client.js"
        data-repo="maodaisuki/hexo-theme-maoblog"
        data-repo-id="R_kgDOKICkkw"
        data-category="Announcements"
        data-category-id="DIC_kwDOKICkk84CZEWg"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
<!-- 前往 https://giscus.app 获取配置代码 -->


  
<script src="/js/mermaid.min.js"></script>



<script src="/js/zoom/jquery.min.js"></script>


<script src="/js/zoom/bootstrap.min.js"></script>


<script src="/js/zoom/zoom.js"></script>


<script src="/js/maoblog.js"></script>


<script src="/js/prism.js"></script>
</div>
        <div class="footer-wrapper"><footer>
  <div class="footer-container">
    <div class="footer-meta">
      
        <div class="footer-meta-copyright">
          &copy; 2025 mao.
        </div>
      
      
        <div class="footer-meta-licenese">
          Licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a>
        </div>
      
      
        <div class="footer-meta-rss">
          <a href="/atom.xml"><i class="fa fa-rss"></i></a>
        </div>
      
    </div>
  </div>
</footer>
</div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    var searchXMLPath = "https://weikangqi.github.io" + "/" + "search.xml"
    console.log(searchXMLPath)
  </script>
  
<script src="/js/search/search.js"></script>

</html>